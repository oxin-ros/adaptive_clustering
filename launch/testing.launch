<launch>
    <!-- Launch the oxin description. -->
    <include file="$(find oxin_description)/launch/oxin_robot.launch"/>

    <!-- Create the nodelet manager. -->
    <node pkg="nodelet" type="nodelet" name="lidar_processing_manager"  args="manager" output="screen"/>

    <!-- Transform the pointcloud to the base_footprint frame. -->
    <node pkg="nodelet" type="nodelet" name="pointcloud_transformer" args="load transform_pointcloud/transformPointcloud lidar_processing_manager" output="screen">
        <!-- Transform the point cloud frame to the base_footprint frame. -->
        <param name="to_frame" value="base_footprint"/>
        <param name="transform_timeout" value=".5"/>
        <!-- Read in the lidar point clouds. -->
        <remap from="~input" to="/livox/lidar"/>
        <remap from="~output" to="/points/transformed"/>
    </node>

    <!-- Ground plane detection. -->
    <include file="$(find ground_plane_filter)/launch/ground_plane_filter.launch">
        <arg name="nodelet_manager_name" value="lidar_processing_manager"/>
        <arg name="use_external_manager" value="true"/>
        <arg name="input_topic" value="/points/transformed"/>
    </include>

    <!-- Run a VoxelGrid filter to clean NaNs and downsample the data. -->
    <node pkg="nodelet" type="nodelet" name="voxel_grid" args="load pcl/VoxelGrid lidar_processing_manager" output="screen">
        <remap from="~input"  to="/points/non_ground" />
        <rosparam>
            filter_field_name: z
            filter_limit_min: 0
            filter_limit_max: 5
            filter_limit_negative: False
            leaf_size: 0.04
        </rosparam>
    </node>

    <node pkg="adaptive_clustering_gpu" name="adaptive_clustering_gpu" type="adaptive_clustering_gpu">
        <remap from="~input"  to="/voxel_grid/output" />
        <rosparam>
            print_fps: true
            cluster_size_min: 100
            cluster_size_max: 10000
        </rosparam>
    </node>
    
    <node pkg="rviz" type="rviz" name="rviz" args="-d $(find adaptive_clustering_gpu)/launch/adaptive_clustering_gpu.rviz"/>
</launch>
